<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì†Œë¦¬ ì„±ì°°ì‹¤ (MelodyMind)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .prose {
            max-width: 65ch;
            line-height: 1.75;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // =========================
        // Global State Management
        // =========================
        const state = {
            page: 1,
            loading: false,
            userId: "Guest",
            db: null,
            appData: {
                url: '', title: '', composer: '', artist: '',
                ensembleType1: '', ensembleType2: '', musicGenre: '', lyrics: '', experienceLevel: 'ì´ˆì‹¬',
                senseKeywords: [], senseText: '', senseColor: '#3B82F6', senseImage: null,
                tech: '', analysis: '',
                interpretation: '', evaluation: '',
                feedback: {
                    senseScore: 50, analysisScore: 50, aestheticScore: 50,
                    goodPoints: '', badPoints: '', structuredQuestion: ''
                },
                finalAppreciation: '',
                scores: [50, 50, 50],
                colors: ['#3B82F6', '#1E40AF', '#6366F1'],
                strategy: { performance: '', appreciation: '', composition: '' }
            },
            feedbackInput: '',
            showErrorModal: false,
            errorMessage: '',
            visualizationScene: null
        };

        // =========================
        // Icon Component (SVG)
        // =========================
        const icons = {
            Music: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>`,
            Feather: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5.26 10.74 3 13V19l6 2 3-3"/><path d="M14.49 5.51 16.2 3.8a2 2 0 0 1 2.83 2.83l-1.71 1.71"/><path d="m9 11 8.5-8.5"/><path d="m11 9 8.5-8.5"/><path d="M12 18H7"/><path d="M15 21v-3"/></svg>`,
            Eye: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>`,
            Gauge: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19A8 8 0 1 1 12 20"/><path d="M18.83 14.66L17.2 13"/><path d="M13 13h6"/></svg>`,
            Lightbulb: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 14c.2-1.1.7-2.2 1.4-3.1 2-2.5 2.5-4.7 1.5-6.7-1-2-2.8-3.2-5.4-3.2h-.6C9.6 1 8 2.2 7 4.2c-1 2-.5 4.2 1.5 6.7.7.9 1.2 2 1.4 3.1"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>`,
            BarChart: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
            MessageCircle: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/><circle cx="12" cy="12" r="4"/></svg>`,
            X: (size = 20) => `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`
        };

        // =========================
        // Backend API Functions (.env ì‚¬ìš©)
        // =========================
        const API_BASE_URL = window.location.origin; // í˜„ì¬ ì„œë²„ ì£¼ì†Œ ì‚¬ìš©

        async function analyzeWithGPT(systemInstruction, userPrompt, jsonOutput = false) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction,
                        userPrompt,
                        jsonOutput
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                return data.result || "AI ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
            } catch (error) {
                console.error("API Error:", error);
                return `AI ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`;
            }
        }

        // Google Forms ë°ì´í„° ì „ì†¡ í•¨ìˆ˜
        async function sendToGoogleForms(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/google-forms`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                return result;
            } catch (error) {
                console.error("Google Forms Error:", error);
                return { success: false, error: error.message };
            }
        }

        function getAppreciationDataForAI() {
            const d = state.appData;
            return `
--- ì•…ê³¡ ì •ë³´ ---
ì œëª©: ${d.title || 'ë¯¸ì…ë ¥'}, ì‘ê³¡ê°€: ${d.composer || 'ë¯¸ì…ë ¥'}, ì—°ì£¼ì: ${d.artist || 'ë¯¸ì…ë ¥'}, ì¥ë¥´: ${d.musicGenre || 'ë¯¸ì…ë ¥'}
ê²½í—˜ ìˆ˜ì¤€: ${d.experienceLevel}, ì—°ì£¼ í˜•íƒœ: ${d.ensembleType1} - ${d.ensembleType2}

--- 1ë‹¨ê³„: ë°˜ì‘ (ê°ê°ì  ê°ìƒ) ---
í•µì‹¬ í‚¤ì›Œë“œ: ${d.senseKeywords.join(', ') || 'ì—†ìŒ'}
ììœ  ì„œìˆ : ${d.senseText || 'ì—†ìŒ'}
ì„ íƒ ìƒ‰ìƒ: ${d.senseColor}

--- 2ë‹¨ê³„: ê¸°ìˆ  ë° ë¶„ì„ ---
ê¸°ìˆ (ì†Œë¦¬): ${d.tech || 'ë¯¸ì…ë ¥'}
ë¶„ì„(íŒ¨í„´): ${d.analysis || 'ë¯¸ì…ë ¥'}

--- 3ë‹¨ê³„: í•´ì„ ë° í‰ê°€ ---
í•´ì„(ì˜ë¯¸): ${d.interpretation || 'ë¯¸ì…ë ¥'}
í‰ê°€(ê°€ì¹˜): ${d.evaluation || 'ë¯¸ì…ë ¥'}
            `;
        }

        async function generateFeedback() {
            state.loading = true;
            render();

            const appreciationData = getAppreciationDataForAI();
            const systemInstruction = `
ë‹¹ì‹ ì€ ìŒì•… êµìœ¡ ì „ë¬¸ê°€ì´ì ë¹„í‰ê°€ì…ë‹ˆë‹¤. í íŠ¸ë§Œ/ì•¤ë”ìŠ¨ì˜ 5ë‹¨ê³„ ë¹„í‰ êµ¬ì¡°(ë°˜ì‘-ê¸°ìˆ -ë¶„ì„-í•´ì„-í‰ê°€)ì— ë”°ë¼ í•™ìƒì˜ ê°ìƒë¬¸ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³ , ë…¼ë¦¬ì /ìŒì•…ì  ê·¼ê±° ì œì‹œ ì—¬ë¶€ë¥¼ ì§„ë‹¨í•©ë‹ˆë‹¤.
ìµœì¢… ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ìœ¼ë¡œ ì œê³µë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

--- ë¶„ì„ ê¸°ì¤€ ---
1. ê°ê°ì  ë¯¼ê°ë„(senseScore): ê°ê°ì  ì„œìˆ (P1)ì´ ì•…ê³¡ì˜ ì‹¤ì œ ì…ˆì—¬ë¦¼/ë¹ ë¥´ê¸°ì™€ ì–¼ë§ˆë‚˜ ì¼ì¹˜í•˜ëŠ”ê°€? (1-100ì )
2. ë¶„ì„ì  ì´í•´ë„(analysisScore): ê¸°ìˆ /ë¶„ì„(P2) ë‹µë³€ì´ ì•…ê³¡ì˜ ê°ê´€ì  ìš”ì†Œì™€ ì–¼ë§ˆë‚˜ ì¼ì¹˜í•˜ëŠ”ê°€? (1-100ì )
3. ì‹¬ë¯¸ì  í†µì°°ë ¥(aestheticScore): í•´ì„/í‰ê°€(P3) ë‚´ìš©ì´ ê¸°ìˆ /ë¶„ì„(P2) ì‚¬ì‹¤ì— ì–¼ë§ˆë‚˜ ë…¼ë¦¬ì ìœ¼ë¡œ ê·¼ê±°í•˜ëŠ”ê°€? (1-100ì )
4. goodPoints: êµ¬ì²´ì ì¸ ì¹­ì°¬ 2~3ê°€ì§€
5. badPoints: ë…¼ë¦¬ì /ìŒì•…ì  ê·¼ê±° ë¶€ì¡± ë“± ë³´ì™„í•  ì  2~3ê°€ì§€
6. structuredQuestion: ë³´ì™„í•  ì ì„ í•´ê²°í•  ìˆ˜ ìˆë„ë¡ ì‚¬ê³ ë¥¼ ì´‰ì§„í•˜ëŠ” êµ¬ì¡°í™”ëœ ì§ˆë¬¸ 1ê°œ
            `;

            try {
                const gptResult = await analyzeWithGPT(systemInstruction, appreciationData, true);
                const parsedResult = JSON.parse(gptResult.replace(/```json|```/g, '').trim());

                state.appData.scores = [parsedResult.senseScore, parsedResult.analysisScore, parsedResult.aestheticScore];
                state.appData.feedback = {
                    senseScore: parsedResult.senseScore,
                    analysisScore: parsedResult.analysisScore,
                    aestheticScore: parsedResult.aestheticScore,
                    goodPoints: parsedResult.goodPoints,
                    badPoints: parsedResult.badPoints,
                    structuredQuestion: parsedResult.structuredQuestion
                };
                state.page = 4;
            } catch (error) {
                showModal("AI ë¶„ì„ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            } finally {
                state.loading = false;
                render();
            }
        }

        async function generateFinalOutput(finalInput) {
            state.loading = true;
            render();

            const appreciationData = getAppreciationDataForAI();
            const systemInstruction = `
ë‹¹ì‹ ì€ ìŒì•… êµìœ¡ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í•™ìƒì˜ ê°ìƒë¬¸ ì´ˆì•ˆê³¼ ë³´ì™„ ë‚´ìš©ì„ ì¢…í•©í•˜ì—¬ ì•„ë˜ í•­ëª©ì„ JSON í˜•ì‹ìœ¼ë¡œ ìƒì„±í•´ì£¼ì„¸ìš”.

1. finalAppreciation: í•™ìƒì˜ ë³´ì™„ëœ ë‚´ìš©ì„ í¬í•¨í•œ ìµœì¢… ê°ìƒë¬¸ í…ìŠ¤íŠ¸ (5ë‹¨ê³„ ë¹„í‰ êµ¬ì¡° ë°˜ì˜)
2. performanceStrategy: ì—°ì£¼ ì˜ì—­ í™œìš© ì „ëµ
3. appreciationStrategy: ê°ìƒ ì˜ì—­ í™œìš© ì „ëµ
4. compositionStrategy: ì°½ì‘ ì˜ì—­ í™œìš© ì „ëµ
            `;

            const userPrompt = `
--- 1~3ë‹¨ê³„ í†µí•© ê°ìƒ ë°ì´í„° ---
${appreciationData}

--- AI í”¼ë“œë°± ---
ì¹­ì°¬: ${state.appData.feedback.goodPoints}
ë³´ì™„ì : ${state.appData.feedback.badPoints}
ì§ˆë¬¸: ${state.appData.feedback.structuredQuestion}

--- ë³´ì™„ëœ ê°ìƒ ë‚´ìš© ---
${finalInput}

ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìµœì¢… ê°ìƒë¬¸ê³¼ ë¯¸ë˜ í™œìš© ì „ëµì„ ìƒì„±í•´ì£¼ì„¸ìš”.
            `;

            try {
                const gptResult = await analyzeWithGPT(systemInstruction, userPrompt, true);
                const parsedResult = JSON.parse(gptResult.replace(/```json|```/g, '').trim());

                state.appData.finalAppreciation = parsedResult.finalAppreciation;
                state.appData.strategy = {
                    performance: parsedResult.performanceStrategy,
                    appreciation: parsedResult.appreciationStrategy,
                    composition: parsedResult.compositionStrategy
                };

                // Google Formsë¡œ ë°ì´í„° ì „ì†¡
                const googleFormsData = {
                    userId: state.userId,
                    timestamp: new Date().toISOString(),
                    // ì•…ê³¡ ì •ë³´
                    title: state.appData.title,
                    url: state.appData.url,
                    artist: state.appData.artist,
                    composer: state.appData.composer,
                    musicGenre: state.appData.musicGenre,
                    ensembleType1: state.appData.ensembleType1,
                    // ê°ìƒ ë°ì´í„°
                    senseKeywords: state.appData.senseKeywords.join(', '),
                    senseText: state.appData.senseText,
                    senseColor: state.appData.senseColor,
                    tech: state.appData.tech,
                    analysis: state.appData.analysis,
                    interpretation: state.appData.interpretation,
                    evaluation: state.appData.evaluation,
                    // AI ë¶„ì„ ê²°ê³¼
                    senseScore: state.appData.scores[0],
                    analysisScore: state.appData.scores[1],
                    aestheticScore: state.appData.scores[2],
                    goodPoints: state.appData.feedback.goodPoints,
                    badPoints: state.appData.feedback.badPoints,
                    structuredQuestion: state.appData.feedback.structuredQuestion,
                    feedbackInput: state.feedbackInput,
                    // ìµœì¢… ê²°ê³¼
                    finalAppreciation: state.appData.finalAppreciation,
                    performanceStrategy: state.appData.strategy.performance,
                    appreciationStrategy: state.appData.strategy.appreciation,
                    compositionStrategy: state.appData.strategy.composition
                };

                const googleFormsResult = await sendToGoogleForms(googleFormsData);
                console.log('ğŸ“ Google Forms ì „ì†¡ ê²°ê³¼:', googleFormsResult);

                state.page = 5;
            } catch (error) {
                showModal("ìµœì¢… ê²°ê³¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            } finally {
                state.loading = false;
                render();
            }
        }

        // =========================
        // Three.js Visualization
        // =========================
        function initVisualization(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear existing content
            container.innerHTML = '';

            const [sense, analysis, aesthetic] = state.appData.scores;
            const sizeFactor = 0.5 + sense / 200;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, 400 / 200, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(400, 200);
            container.appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            const pointLight = new THREE.PointLight(0xffffff, 1);
            pointLight.position.set(5, 5, 5);
            scene.add(pointLight);

            const geometry = new THREE.DodecahedronGeometry(sizeFactor * 1.5, 0);
            const color = new THREE.Color(state.appData.colors[0] || 0xcccccc);
            const material = new THREE.MeshPhongMaterial({ color: color, flatShading: true });
            const structure = new THREE.Mesh(geometry, material);
            scene.add(structure);

            const detailGeometry = new THREE.TorusKnotGeometry(1.5 * sizeFactor, 0.3 * sizeFactor, 64, 8);
            const detailColor = new THREE.Color(state.appData.colors[1] || 0x888888);
            const detailMaterial = new THREE.MeshPhongMaterial({ 
                color: detailColor, 
                wireframe: true, 
                transparent: true, 
                opacity: aesthetic / 100 
            });
            const detail = new THREE.Mesh(detailGeometry, detailMaterial);
            scene.add(detail);

            camera.position.z = 5;

            function animate() {
                requestAnimationFrame(animate);
                structure.rotation.x += sense / 5000;
                structure.rotation.y += sense / 5000;
                detail.rotation.x += analysis / 15000;
                detail.rotation.y += analysis / 15000;
                renderer.render(scene, camera);
            }
            animate();

            state.visualizationScene = { renderer, scene, geometry, material, detailGeometry, detailMaterial };
        }

        // =========================
        // Modal Functions
        // =========================
        function showModal(message) {
            state.errorMessage = message;
            state.showErrorModal = true;
            render();
        }

        function closeModal() {
            state.showErrorModal = false;
            render();
        }

        // =========================
        // Navigation & Validation
        // =========================
        async function handleNext() {
            if (state.loading) return;

            switch (state.page) {
                case 1:
                    if (!state.appData.title || !state.appData.url || state.appData.senseKeywords.length === 0) {
                        showModal("ì•…ê³¡ ì œëª©, ìœ íŠœë¸Œ ë§í¬, ê°ì„± í‚¤ì›Œë“œëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.");
                        return;
                    }
                    state.page = 2;
                    render();
                    break;
                case 2:
                    if (!state.appData.tech || !state.appData.analysis) {
                        showModal("ê¸°ìˆ (ì†Œë¦¬) ë° ë¶„ì„(íŒ¨í„´) ì˜ì—­ì˜ ê°ìƒí‰ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    state.page = 3;
                    render();
                    break;
                case 3:
                    if (!state.appData.interpretation || !state.appData.evaluation) {
                        showModal("í•´ì„(ì˜ë¯¸) ë° í‰ê°€(ê°€ì¹˜) ì˜ì—­ì˜ ê°ìƒí‰ì„ ëª¨ë‘ ì‘ì„±í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    await generateFeedback();
                    break;
                case 4:
                    if (!state.feedbackInput) {
                        showModal("AIì˜ ì§ˆë¬¸ì— ëŒ€í•œ ë³´ì™„ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    await generateFinalOutput(state.feedbackInput);
                    break;
                default:
                    state.page = 1;
                    render();
            }
        }

        // =========================
        // Page Components (HTML)
        // =========================
        function renderHeader() {
            return `
                <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg rounded-t-xl flex justify-between items-center">
                    <h1 class="text-2xl font-bold flex items-center">
                        ${icons.Music(24)} <span class="ml-2">ì†Œë¦¬ ì„±ì°°ì‹¤ (MelodyMind)</span>
                    </h1>
                    <span class="text-sm opacity-75">ì‚¬ìš©ì ID: ${state.userId.substring(0, 8)}...</span>
                </header>
            `;
        }

        function renderStepIndicator() {
            if (state.page > 3) return '';
            
            let steps = '';
            for (let i = 1; i <= 3; i++) {
                const activeClass = i === state.page 
                    ? 'bg-indigo-500 text-white shadow-lg' 
                    : 'bg-gray-200 text-gray-500';
                steps += `<div class="flex-1 text-center mx-1 py-2 rounded-full font-semibold transition-all duration-300 ${activeClass}">${i}ë‹¨ê³„</div>`;
            }
            return `<div class="flex justify-between items-center my-4">${steps}</div>`;
        }

        function renderPage1() {
            const keywords = ['ê¸°ì¨', 'ìŠ¬í””', 'ê¸´ì¥', 'í‰í™”', 'ì—­ë™ì ', 'ì“¸ì“¸í•¨', 'ê²½ì¾Œí•¨', 'ì›…ì¥í•¨'];
            const keywordButtons = keywords.map(keyword => {
                const isActive = state.appData.senseKeywords.includes(keyword);
                const activeClass = isActive 
                    ? 'bg-indigo-500 text-white shadow-md' 
                    : 'bg-gray-100 text-gray-600 hover:bg-indigo-100';
                return `<button onclick="toggleKeyword('${keyword}')" class="px-3 py-1 text-sm rounded-full transition-colors duration-200 ${activeClass}">${keyword}</button>`;
            }).join('');

            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">1ë‹¨ê³„: ì•…ê³¡ ì •ë³´ ë° ê°ê°ì  ê°ìƒ (ë°˜ì‘)</h2>
                    
                    <div class="bg-white p-4 rounded-lg shadow-md border border-indigo-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ìœ íŠœë¸Œ ë§í¬ (í•„ìˆ˜)</label>
                        <input type="text" id="url" value="${state.appData.url}" oninput="updateField('url', this.value)" 
                            placeholder="https://www.youtube.com/watch?v=..." 
                            class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500" />
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-4 rounded-lg shadow-md border border-indigo-100">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ì•…ê³¡ ì œëª© / ì‘ê³¡ê°€</label>
                            <input type="text" id="title" value="${state.appData.title}" oninput="updateField('title', this.value)" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ê°€ìˆ˜ / ì—°ì£¼ì ì´ë¦„</label>
                            <input type="text" id="artist" value="${state.appData.artist}" oninput="updateField('artist', this.value)" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ì—°ì£¼ í˜•íƒœ 1 (ê¸°ì•…/ì„±ì•…)</label>
                            <select id="ensembleType1" onchange="updateField('ensembleType1', this.value)" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1">
                                <option value="">ì„ íƒ</option>
                                <option value="ê¸°ì•…ê³¡" ${state.appData.ensembleType1 === 'ê¸°ì•…ê³¡' ? 'selected' : ''}>ê¸°ì•…ê³¡</option>
                                <option value="ì„±ì•…ê³¡" ${state.appData.ensembleType1 === 'ì„±ì•…ê³¡' ? 'selected' : ''}>ì„±ì•…ê³¡</option>
                                <option value="ì˜ ëª¨ë¥´ê² ìŒ" ${state.appData.ensembleType1 === 'ì˜ ëª¨ë¥´ê² ìŒ' ? 'selected' : ''}>ì˜ ëª¨ë¥´ê² ìŒ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">ìŒì•… ë¶„ë¥˜ (ì¥ë¥´)</label>
                            <select id="musicGenre" onchange="updateField('musicGenre', this.value)" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1">
                                <option value="">ì„ íƒ</option>
                                <option value="ëŒ€ì¤‘ìŒì•…" ${state.appData.musicGenre === 'ëŒ€ì¤‘ìŒì•…' ? 'selected' : ''}>ëŒ€ì¤‘ìŒì•…</option>
                                <option value="êµ­ì•…" ${state.appData.musicGenre === 'êµ­ì•…' ? 'selected' : ''}>êµ­ì•…</option>
                                <option value="ì„œì–‘ìŒì•…" ${state.appData.musicGenre === 'ì„œì–‘ìŒì•…' ? 'selected' : ''}>ì„œì–‘ìŒì•…</option>
                                <option value="ì„¸ê³„ìŒì•…" ${state.appData.musicGenre === 'ì„¸ê³„ìŒì•…' ? 'selected' : ''}>ì„¸ê³„ìŒì•…</option>
                                <option value="ì˜ ëª¨ë¥´ê² ìŒ" ${state.appData.musicGenre === 'ì˜ ëª¨ë¥´ê² ìŒ' ? 'selected' : ''}>ì˜ ëª¨ë¥´ê² ìŒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4 bg-white p-4 rounded-lg shadow-md border border-indigo-100">
                        <h3 class="font-bold text-lg text-indigo-600">ê°ê°ì  ê°ìƒ (1. ë°˜ì‘)</h3>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ê°ì„± í‚¤ì›Œë“œ (2~3ê°€ì§€ ì„ íƒ)</label>
                            <div class="flex flex-wrap gap-2">
                                ${keywordButtons}
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">ëŠë‚Œ/ë¶„ìœ„ê¸° ì„œìˆ  (50ì ë‚´ì™¸)</label>
                            <textarea id="senseText" oninput="updateField('senseText', this.value.substring(0, 50))" 
                                rows="2" placeholder="ì˜ˆ: ì´ë²ˆ ì—¬ë¦„ ë°©í•™ ë•Œ ì•„ë¹ , ì—„ë§ˆë‘ ë³´ì•˜ë˜ ë‹¬ì´ ë– ìˆë˜ ê°•ì›ë„ ë°”ë‹¤ê°€ ë– ì˜¬ëì–´ìš”. ê³ ìš”í•¨ ì†ì—ì„œ ë¶ˆì•ˆê°ì´ ëŠê»´ì ¸ìš”." 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1">${state.appData.senseText}</textarea>
                            <p class="text-right text-xs text-gray-500">${state.appData.senseText.length} / 50 ì</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700">í•µì‹¬ ìƒ‰ìƒ (1ê°€ì§€ ì„ íƒ)</label>
                            <select id="senseColor" onchange="updateField('senseColor', this.value)" 
                                class="w-full p-2 border border-gray-300 rounded-md mt-1">
                                <option value="#3B82F6" ${state.appData.senseColor === '#3B82F6' ? 'selected' : ''}>íŒŒë‘ (í‰í™”, ê³ ìš”)</option>
                                <option value="#EF4444" ${state.appData.senseColor === '#EF4444' ? 'selected' : ''}>ë¹¨ê°• (ê¸´ì¥, ì—­ë™)</option>
                                <option value="#10B981" ${state.appData.senseColor === '#10B981' ? 'selected' : ''}>ì´ˆë¡ (ì•ˆì •, ìì—°)</option>
                                <option value="#F59E0B" ${state.appData.senseColor === '#F59E0B' ? 'selected' : ''}>ë…¸ë‘ (ê¸°ì¨, ë°ìŒ)</option>
                                <option value="#4B5563" ${state.appData.senseColor === '#4B5563' ? 'selected' : ''}>íšŒìƒ‰ (ì“¸ì“¸í•¨, ì–´ë‘ì›€)</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPage2() {
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">2ë‹¨ê³„: ë¶„ì„ì  ê°ìƒ (2. ê¸°ìˆ , 3. ë¶„ì„)</h2>
                    
                    <p class="text-sm text-gray-500 bg-yellow-50 p-3 rounded-lg flex items-center">
                        ${icons.Lightbulb(16)}
                        <span class="ml-2"><strong>AI íŒíŠ¸:</strong> 1ë‹¨ê³„ ê°ìƒ ê²°ê³¼, <strong>ë¦¬ë“¬ ë° í…œí¬</strong> ë³€í™”ì— ë¯¼ê°í•˜ì…¨ìŠµë‹ˆë‹¤. <strong>ê³¡ì´ ë¹¨ë¼ì§€ê±°ë‚˜ ëŠë ¤ì§€ëŠ” ë¶€ë¶„</strong>ì„ ì°¾ì•„ë³´ë©° ë¶„ì„ì„ ì‹œì‘í•´ ë³´ì„¸ìš”.</span>
                    </p>

                    <div class="bg-white p-4 rounded-lg shadow-md border border-indigo-100 space-y-4">
                        <h3 class="font-bold text-lg text-indigo-600">2. ê¸°ìˆ  (ê°ê´€ì  ì†Œë¦¬ ê´€ì°°)</h3>
                        <label class="block text-sm font-medium text-gray-700">ì†Œë¦¬: ìŒìƒ‰, ì…ˆì—¬ë¦¼, ë¹ ë¥´ê¸° ë“±</label>
                        <textarea id="tech" oninput="updateField('tech', this.value)" rows="3" 
                            placeholder="ì˜ˆ: í”¼ì•„ë…¸ê°€ ì…‹ì‡ë‹¨ìŒí‘œë¡œ ë°˜ë³µë˜ì–´ ë§ë°œêµ½ ì†Œë¦¬ì²˜ëŸ¼ ë“¤ë¦¬ê³ , ë§ˆì™•ì˜ ëª©ì†Œë¦¬ê°€ ë¶€ë“œëŸ½ê³  ëˆì í•˜ê²Œ ë³€í•©ë‹ˆë‹¤." 
                            class="w-full p-2 border border-gray-300 rounded-md mt-1">${state.appData.tech}</textarea>

                        <h3 class="font-bold text-lg text-indigo-600">3. ë¶„ì„ (íŒ¨í„´ ë° êµ¬ì¡° íŒŒì•…)</h3>
                        <label class="block text-sm font-medium text-gray-700">íŒ¨í„´: ë¦¬ë“¬, ë©œë¡œë””, í˜•ì‹, í™”ì„±(ì¡°ì„±) ë“±</label>
                        <textarea id="analysis" oninput="updateField('analysis', this.value)" rows="3" 
                            placeholder="ì˜ˆ: í”¼ì•„ë…¸ì˜ ì…‹ì‡ë‹¨ìŒí‘œ ë¦¬ë“¬ì´ ê³„ì† ë°˜ë³µë˜ì–´ ê¸´ì¥ê°ì„ ì¡°ì„±í•©ë‹ˆë‹¤." 
                            class="w-full p-2 border border-gray-300 rounded-md mt-1">${state.appData.analysis}</textarea>
                    </div>

                    <div class="text-center">
                        <button onclick="showModal('í˜‘ë ¥ ë¶„ì„ ìš”ì²­ ê¸°ëŠ¥ì€ í˜„ì¬ ë² íƒ€ í…ŒìŠ¤íŠ¸ ì¤‘ì…ë‹ˆë‹¤.')" 
                            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300 transition-colors inline-flex items-center">
                            ${icons.MessageCircle(16)}
                            <span class="ml-2">í˜‘ë ¥ ë¶„ì„ ìš”ì²­í•˜ê¸°</span>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPage3() {
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-700">3ë‹¨ê³„: ì‹¬ë¯¸ì  ê°ìƒ (4. í•´ì„, 5. í‰ê°€)</h2>
                    
                    <p class="text-sm text-gray-500 bg-yellow-50 p-3 rounded-lg flex items-center">
                        ${icons.Lightbulb(16)}
                        <span class="ml-2"><strong>AI íŒíŠ¸:</strong> 2ë‹¨ê³„ ë¶„ì„ì„ ë°”íƒ•ìœ¼ë¡œ ì´ ê³¡ì´ ë‹¹ì‹ ì—ê²Œ ì–´ë–¤ ì˜ë¯¸ë¥¼ ì£¼ëŠ”ì§€, ë˜ëŠ” ì‚¬íšŒì  ì—­í• ì€ ë¬´ì—‡ì¸ì§€ íƒìƒ‰í•´ ë³´ì„¸ìš”.</span>
                    </p>

                    <div class="bg-white p-4 rounded-lg shadow-md border border-indigo-100 space-y-4">
                        <h3 class="font-bold text-lg text-indigo-600">4. í•´ì„ (ì˜ë¯¸ ì¶”ë¡  ë° ë°°ê²½ ì´í•´)</h3>
                        <label class="block text-sm font-medium text-gray-700">ì˜ë¯¸: ì‘ê³¡ ë°°ê²½, ì „ë‹¬ ë©”ì‹œì§€, ë– ì˜¤ë¥¸ ê¸°ì–µ ë“±</label>
                        <textarea id="interpretation" oninput="updateField('interpretation', this.value)" rows="3" 
                            placeholder="ì˜ˆ: ë‚­ë§Œì£¼ì˜ ì‹œëŒ€ì˜ ì´ˆìì—°ì  ì¡´ì¬ì™€ ê³µí¬ì— ëŒ€í•œ ê´€ì‹¬ì„ ë°˜ì˜í•˜ë©°, ìš´ëª…ì  ë¹„ê·¹ì„ ì „ë‹¬í•œë‹¤ê³  í•´ì„í–ˆìŠµë‹ˆë‹¤." 
                            class="w-full p-2 border border-gray-300 rounded-md mt-1">${state.appData.interpretation}</textarea>

                        <h3 class="font-bold text-lg text-indigo-600">5. í‰ê°€ (ê°€ì¹˜ íŒë‹¨ ë° í™•ì¥ ì ìš©)</h3>
                        <label class="block text-sm font-medium text-gray-700">ê°€ì¹˜: ì˜ˆìˆ ì  í‰ê°€, ìƒí™œ ì† í™œìš© ë°©ì•ˆ ë“±</label>
                        <textarea id="evaluation" oninput="updateField('evaluation', this.value)" rows="3" 
                            placeholder="ì˜ˆ: ì´ ê³¡ì€ í•œ í¸ì˜ ì§§ì€ ì˜¤í˜ë¼ ê°™ì•„ ì˜ˆìˆ ì  ê°€ì¹˜ê°€ ë†’ìœ¼ë©°, ì˜í™”ì˜ í´ë¼ì´ë§¥ìŠ¤ BGMìœ¼ë¡œ í™œìš©í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤." 
                            class="w-full p-2 border border-gray-300 rounded-md mt-1">${state.appData.evaluation}</textarea>
                    </div>
                </div>
            `;
        }

        function renderPage4() {
            return `
                <div class="space-y-6">
                    <h2 class="text-xl font-semibold text-red-600 flex items-center">
                        ${icons.BarChart(20)}
                        <span class="ml-2">ê°ìƒë¬¸ ì§„ë‹¨ ë° ë³´ì™„ ë‹¨ê³„ (AI í”¼ë“œë°± ìˆœí™˜)</span>
                    </h2>

                    <div class="bg-white p-4 rounded-lg shadow-md border border-red-200 space-y-4">
                        <h3 class="font-bold text-lg text-green-600">AI ì§„ë‹¨ - ì˜ëœ ì  (ì¹­ì°¬)</h3>
                        <p class="text-sm text-gray-800 bg-green-50 p-3 rounded-md">${state.appData.feedback.goodPoints}</p>

                        <h3 class="font-bold text-lg text-red-600">AI ì§„ë‹¨ - ë³´ì™„í•  ì  (ì§„ë‹¨)</h3>
                        <p class="text-sm text-gray-800 bg-red-50 p-3 rounded-md">${state.appData.feedback.badPoints}</p>

                        <h3 class="font-bold text-lg text-indigo-600">AI ì‹¬í™” ì§ˆë¬¸ (êµ¬ì¡°í™”ëœ ì§ˆë¬¸)</h3>
                        <p class="text-sm font-semibold text-gray-900 bg-indigo-50 p-3 rounded-md">${state.appData.feedback.structuredQuestion}</p>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700">ê°ìƒë¬¸ ë³´ì™„ ë‚´ìš© ì§ì ‘ ì…ë ¥</label>
                        <textarea id="feedbackInput" oninput="state.feedbackInput = this.value" rows="5" 
                            placeholder="AIì˜ ì§ˆë¬¸ì„ ì°¸ê³ í•˜ì—¬ ê°ìƒë¬¸ì„ ë³´ì™„í•  ë‚´ìš©ì„ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”." 
                            class="w-full p-2 border border-red-300 rounded-md focus:ring-red-500 focus:border-red-500">${state.feedbackInput}</textarea>
                    </div>
                </div>
            `;
        }

        function renderPage5() {
            // Initialize visualization after render
            setTimeout(() => initVisualization('visualization-container'), 100);

            return `
                <div class="space-y-6">
                    <h2 class="text-2xl font-bold text-indigo-700 flex items-center">
                        ${icons.Feather(24)}
                        <span class="ml-2">ìµœì¢… ê°ìƒ ë³´ê³ ì„œ ë° í™œìš© ì „ëµ</span>
                    </h2>

                    <h3 class="text-xl font-semibold text-gray-700">1. ê°ìƒ ëŠ¥ë ¥ ì§€í‘œ ì‹œê°í™” (AI ë¶„ì„ ê²°ê³¼)</h3>
                    <div id="visualization-container" class="w-full h-48 bg-gray-900 rounded-xl shadow-lg flex items-center justify-center overflow-hidden"></div>
                    
                    <div class="grid grid-cols-3 gap-2 text-center text-sm font-semibold text-gray-700 bg-gray-100 p-2 rounded-lg">
                        <div class="flex items-center justify-center">${icons.Eye(16)} <span class="ml-1">ë¯¼ê°ë„: ${state.appData.scores[0]}ì </span></div>
                        <div class="flex items-center justify-center">${icons.Gauge(16)} <span class="ml-1">ì´í•´ë„: ${state.appData.scores[1]}ì </span></div>
                        <div class="flex items-center justify-center">${icons.Lightbulb(16)} <span class="ml-1">í†µì°°ë ¥: ${state.appData.scores[2]}ì </span></div>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-md border border-indigo-200">
                        <h3 class="text-xl font-semibold text-indigo-600 mb-3">2. ë³´ì™„ëœ ìµœì¢… ìŒì•… ê°ìƒë¬¸</h3>
                        <div class="prose text-gray-800 text-sm whitespace-pre-wrap">
                            ${state.appData.finalAppreciation || "ìµœì¢… ê°ìƒë¬¸ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆê±°ë‚˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."}
                        </div>
                    </div>

                    <div class="space-y-3 bg-white p-4 rounded-lg shadow-md border border-green-200">
                        <h3 class="text-xl font-semibold text-green-600">3. ë¯¸ë˜ í™œë™ ì—°ê³„ í™œìš© ì „ëµ</h3>
                        <div class="text-sm space-y-2">
                            <p><strong class="text-blue-700">â–¶ ì—°ì£¼ ì „ëµ:</strong> ${state.appData.strategy.performance}</p>
                            <p><strong class="text-blue-700">â–¶ ê°ìƒ ì „ëµ:</strong> ${state.appData.strategy.appreciation}</p>
                            <p><strong class="text-blue-700">â–¶ ì°½ì‘ ì „ëµ:</strong> ${state.appData.strategy.composition}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderFooter() {
            const buttonText = state.loading ? "AI ë¶„ì„ ì¤‘..." : 
                state.page === 1 || state.page === 2 ? "ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™" :
                state.page === 3 ? "AI ì§„ë‹¨ ì‹œì‘" :
                state.page === 4 ? "ìµœì¢… ê°ìƒë¬¸ ì™„ì„±" :
                "ì™„ë£Œ";
            
            const disabled = state.loading || state.page === 5;
            const buttonClass = disabled 
                ? 'bg-gray-400' 
                : 'bg-indigo-600 hover:bg-indigo-700 shadow-xl';

            return `
                <footer class="fixed bottom-0 left-0 right-0 max-w-4xl mx-auto bg-white p-4 border-t shadow-2xl">
                    <button onclick="handleNext()" ${disabled ? 'disabled' : ''} 
                        class="w-full py-3 px-4 rounded-lg font-bold text-white transition-colors duration-300 ${buttonClass}">
                        ${buttonText}
                    </button>
                </footer>
            `;
        }

        function renderModal() {
            if (!state.showErrorModal) return '';
            
            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full space-y-4">
                        <h3 class="text-xl font-bold text-red-600 flex items-center">
                            ${icons.X(20)}
                            <span class="ml-2">ì˜¤ë¥˜ ë°œìƒ</span>
                        </h3>
                        <p class="text-gray-700">${state.errorMessage}</p>
                        <button onclick="closeModal()" 
                            class="w-full py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
        }

        // =========================
        // Main Render Function
        // =========================
        function render() {
            const pageContent = 
                state.page === 1 ? renderPage1() :
                state.page === 2 ? renderPage2() :
                state.page === 3 ? renderPage3() :
                state.page === 4 ? renderPage4() :
                renderPage5();

            const html = `
                <div class="max-w-4xl mx-auto p-4 sm:p-6 bg-gray-50 rounded-xl shadow-2xl min-h-screen">
                    ${renderHeader()}
                    ${renderStepIndicator()}
                    <div class="mt-4 pb-24">
                        ${pageContent}
                    </div>
                    ${renderFooter()}
                    ${renderModal()}
                </div>
            `;

            document.getElementById('app').innerHTML = html;
        }

        // =========================
        // Event Handlers (Global)
        // =========================
        function updateField(field, value) {
            state.appData[field] = value;
        }

        function toggleKeyword(keyword) {
            const idx = state.appData.senseKeywords.indexOf(keyword);
            if (idx > -1) {
                state.appData.senseKeywords.splice(idx, 1);
            } else {
                if (state.appData.senseKeywords.length < 3) {
                    state.appData.senseKeywords.push(keyword);
                }
            }
            render();
        }

        // =========================
        // User ID ìƒì„±
        // =========================
        function generateUserId() {
            // ê°„ë‹¨í•œ ê³ ìœ  ID ìƒì„± (íƒ€ì„ìŠ¤íƒ¬í”„ + ëœë¤)
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        }

        // =========================
        // App Initialization
        // =========================
        window.addEventListener('DOMContentLoaded', () => {
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ID ë¶ˆëŸ¬ì˜¤ê¸° ë˜ëŠ” ìƒì„±
            const storedUserId = localStorage.getItem('melodymind_userId');
            if (storedUserId) {
                state.userId = storedUserId;
            } else {
                state.userId = generateUserId();
                localStorage.setItem('melodymind_userId', state.userId);
            }
            
            console.log(`ğŸµ ì‚¬ìš©ì ID: ${state.userId}`);
            render();
        });
    </script>
</body>
</html>
